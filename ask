#!/usr/bin/env bash
set -euo pipefail

MODEL_DEFAULT="PopPooB-D:latest"
API_DEFAULT="http://96.242.172.92:11434/api/generate"

MODEL="${ASK_MODEL:-$MODEL_DEFAULT}"
API="${ASK_API:-$API_DEFAULT}"

LANG_MODE="auto"
MODE="explain"
STREAM="false"
INCLUDE_SYSTEM_INFO="false"
TASK_OVERRIDE=""
RAW_PROMPT="false"
TIMEOUT_SECONDS=""
TEXT=""

print_help() {
  cat <<'USAGE'
Usage:
  ask [options] [text]

Options:
  --zh | --en                Force response language
  --translate | --explain     Choose mode (default: explain)
  --model <name>             Override model
  --api <url>                Override API endpoint
  --stream                   Stream tokens as they arrive
  --system-info              Include basic system info in the prompt
  --task <text>              Override the default task description
  --raw                      Send input as-is (no system prompt)
  --timeout <seconds>        Curl timeout in seconds
  -h | --help                Show this help

Available models:
  PopPooB-D:latest
  PopPooB-G:latest
  PopPooB-Uncensored:latest
  PopPooB-Pin-Yin:latest

Examples:
  ask --explain "What does dmesg do?"
  echo "systemd" | ask --translate
USAGE
}

require_cmd() {
  if ! command -v "$1" >/dev/null 2>&1; then
    echo "Missing dependency: $1" >&2
    exit 1
  fi
}

# -------------------------
# Parse arguments
# -------------------------
while [ $# -gt 0 ]; do
  case "$1" in
    --zh) LANG_MODE="zh" ;;
    --en) LANG_MODE="en" ;;
    --translate) MODE="translate" ;;
    --explain) MODE="explain" ;;
    --model) MODEL="${2:-}"; shift ;;
    --api) API="${2:-}"; shift ;;
    --stream) STREAM="true" ;;
    --system-info) INCLUDE_SYSTEM_INFO="true" ;;
    --task) TASK_OVERRIDE="${2:-}"; shift ;;
    --raw) RAW_PROMPT="true" ;;
    --timeout) TIMEOUT_SECONDS="${2:-}"; shift ;;
    -h|--help) print_help; exit 0 ;;
    *) TEXT="$TEXT $1" ;;
  esac
  shift
done

TEXT="${TEXT# }"

# Read stdin if no args
if [ -z "$TEXT" ] && ! tty -s; then
  TEXT="$(cat)"
fi

if [ -z "$TEXT" ]; then
  print_help
  exit 1
fi

require_cmd jq
require_cmd curl

if [ -z "$MODEL" ] || [ -z "$API" ]; then
  echo "Model and API must be specified." >&2
  exit 1
fi

# -------------------------
# Auto language detection
# -------------------------
if [ "$LANG_MODE" = "auto" ]; then
  if echo "$TEXT" | grep -qP '[\x{4e00}-\x{9fff}]'; then
    LANG_MODE="zh"
  else
    LANG_MODE="en"
  fi
fi

# -------------------------
# Mode handling
# -------------------------
if [ "$MODE" = "translate" ]; then
  TASK_DESC="Translate the following text accurately."
else
  TASK_DESC="Explain the following text clearly as a system assistant."
fi

if [ -n "$TASK_OVERRIDE" ]; then
  TASK_DESC="$TASK_OVERRIDE"
fi

SYSTEM_INFO=""
if [ "$INCLUDE_SYSTEM_INFO" = "true" ]; then
  KERNEL_INFO="$(uname -a 2>/dev/null || true)"
  UPTIME_INFO="$(uptime -p 2>/dev/null || true)"
  OS_INFO="$(lsb_release -d 2>/dev/null | cut -d: -f2- | xargs || true)"
  SYSTEM_INFO=$(cat <<'INFO'
System info:
- Kernel: __KERNEL__
- Uptime: __UPTIME__
- OS: __OS__
INFO
)
  SYSTEM_INFO=${SYSTEM_INFO/__KERNEL__/${KERNEL_INFO}}
  SYSTEM_INFO=${SYSTEM_INFO/__UPTIME__/${UPTIME_INFO}}
  SYSTEM_INFO=${SYSTEM_INFO/__OS__/${OS_INFO}}
fi

# -------------------------
# Build prompt
# -------------------------
PROMPT=$(cat <<PROMPT
You are a Linux system assistant integrated into the OS.

Reply language:
- zh: Simplified Chinese
- en: English

Current language: $LANG_MODE
Mode: $MODE

Rules:
- Be concise
- No markdown
- No emojis
- No speculation

$SYSTEM_INFO
Task:
$TASK_DESC

Input:
$TEXT
PROMPT
)

if [ "$RAW_PROMPT" = "true" ]; then
  PROMPT="$TEXT"
fi

JSON_PROMPT=$(jq -Rn --arg p "$PROMPT" '$p')

# -------------------------
# Call Ollama
# -------------------------
CURL_ARGS=()
if [ -n "$TIMEOUT_SECONDS" ]; then
  CURL_ARGS+=(--max-time "$TIMEOUT_SECONDS")
fi

if [ "$STREAM" = "true" ]; then
  curl -sN "${CURL_ARGS[@]}" "$API" \
    -H "Content-Type: application/json" \
    -d "{\"model\": \"$MODEL\", \"stream\": true, \"prompt\": $JSON_PROMPT}" \
  | jq -r 'if .response then .response else empty end'
else
  curl -s "${CURL_ARGS[@]}" "$API" \
    -H "Content-Type: application/json" \
    -d "{\"model\": \"$MODEL\", \"stream\": false, \"prompt\": $JSON_PROMPT}" \
  | jq -r '.response' \
  | sed 's/\\n/\n/g'
fi
