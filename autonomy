#!/usr/bin/env bash
set -e

AUTON="$HOME/.autonomy"
LOG="$AUTON/autonomy.log"
PROP="$AUTON/proposal.json"

mkdir -p "$AUTON"

log() {
  echo "[$(date -Is)] $1" >> "$LOG"
}

divider() {
  echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
}

# -------- Task input --------
if [ "$#" -gt 0 ]; then
  TASK="$*"
else
  read -p "ðŸ§  Task: " TASK
fi

if [ -z "$TASK" ]; then
  echo "No task provided."
  exit 1
fi

echo
echo "ðŸ§  AUTONOMY OPERATOR"
divider
echo "Task: $TASK"
divider
echo

log "TASK: $TASK"

# -------- Planner --------
echo "â–¶ Planningâ€¦"
planner.py "$TASK" >/dev/null
log "Planner completed"

# -------- Show proposal summary --------
if [ ! -f "$PROP" ]; then
  echo "âŒ Planner failed to produce proposal."
  exit 1
fi

CONF=$(jq -r '.confidence' "$PROP")
STEPS=$(jq -r '.steps | length' "$PROP")

echo "âœ” Plan ready"
echo "  Confidence: $(printf "%.0f" "$(echo "$CONF * 100" | bc -l)")%"
echo "  Steps: $STEPS"
echo

divider
echo "ðŸ“‹ Proposed Steps"
divider

jq -r '.steps[] | "â€¢ \(.id): \(.description)  [risk: \(.risk)]"' "$PROP"

echo
divider

# -------- Debate --------
echo "â–¶ Analyzing steps (debate)â€¦"
echo "  (running in background; this may take a moment)"

# Run debate quietly but non-blocking
(
  debate.py >>"$LOG" 2>&1
) &

DEBATE_PID=$!

# Lightweight progress indicator
while kill -0 "$DEBATE_PID" 2>/dev/null; do
  printf "."
  sleep 2
done
echo
echo "âœ” Debate complete"
log "Debate completed"

echo
divider
echo "â–¶ Opening operator UI"
divider
echo

# -------- UI --------
proposal-ui.py &

wait

echo
divider
echo "âœ” Session finished"
divider
log "Session finished"
