#!/usr/bin/env bash
set -euo pipefail

MODE="explain"
OCR_LANG="chi_sim+eng"
TASK_OVERRIDE=""

usage() {
  cat <<'USAGE'
Usage:
  ask-ocr [options]

Options:
  --translate         Translate the OCR text
  --explain           Explain the OCR text (default)
  --lang <langs>      Tesseract language(s) (default: chi_sim+eng)
  --task <text>       Override the default task description
  -h | --help         Show this help
USAGE
}

while [ $# -gt 0 ]; do
  case "$1" in
    --translate) MODE="translate" ;;
    --explain) MODE="explain" ;;
    --lang) OCR_LANG="${2:-}"; shift ;;
    --task) TASK_OVERRIDE="${2:-}"; shift ;;
    -h|--help) usage; exit 0 ;;
    *) echo "Unknown option: $1" >&2; usage; exit 1 ;;
  esac
  shift
 done

command -v flameshot >/dev/null 2>&1 || { echo "❌ flameshot is required for screenshot capture" >&2; exit 1; }
command -v tesseract >/dev/null 2>&1 || { echo "❌ tesseract is required for OCR" >&2; exit 1; }

TMP_IMG=$(mktemp /tmp/ask_ocr_XXXXXX.png)
TMP_TXT=$(mktemp /tmp/ask_ocr_XXXXXX.txt)
trap 'rm -f "$TMP_IMG" "$TMP_TXT"' EXIT

flameshot gui -p "$TMP_IMG" >/dev/null 2>&1 || exit 1

tesseract "$TMP_IMG" "${TMP_TXT%.*}" -l "$OCR_LANG" >/dev/null 2>&1
TEXT=$(sed '/^\s*$/d' "$TMP_TXT")

[ -n "$TEXT" ] || { echo "❌ OCR found no text" >&2; exit 1; }

if [ -n "$TASK_OVERRIDE" ]; then
  PROMPT="$TASK_OVERRIDE"
elif [ "$MODE" = "translate" ]; then
  PROMPT="Translate the following text accurately."
else
  PROMPT="Explain or translate the following text."
fi

echo "$TEXT" | ask --"$MODE" --task "$PROMPT"
